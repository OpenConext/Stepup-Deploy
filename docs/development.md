# Development setup
Make sure all of the applications and their dependencies have been installed correctly, configure the correct parameters
and follow the installation instructions for each application.

## Useful extensions
* SAML debugging: [SAML Chrome Panel][saml-chrome-panel] or the [SAML Tracer for Firefox][firefox-saml-tracer]
* API interactions: [Postman for Chrome][postman-chrome]

Useful Postman collections can be found on LastPass under `Shared-StepUp`.

## Graylog
Graylog should work out of the box. You can log in using the username `admin` and the password `password`.  
Should no log messages show up, the correct source input should be configured, in the `System/Inputs` screen.
Add a GELF UDP with the configured settings, `port: 12201` and `bind_address: 0.0.0.0` , this should accept
the messages.

You can create a custom dashboard or streams so that you can view only the relevant messages.

## Configuring SimpleSAMLphp for use

For development we use the SimpleSAMLphp installation as IdP. This means that all users are identified by this
installation and as such need to be configured here. Furthermore, various other configuration must be tweaked in order
to make SSP play nice with our applications :)

### Certificates

In order to be able to sign requests, SimpleSAMLphp must have a `server.crt` and `server.pem`. These can either be
generated by yourself, or you can copy the below contents to the corresponding files.

**DO NOTE THAT THESE KEYS ARE INSECURE AND SHOULD ONLY BE USED IN DEVELOPMENT**

```
simplesamlphp $ mkdir cert
simplesamlphp $ cd cert
```

server.crt:
```
-----BEGIN CERTIFICATE-----
MIIDzTCCArWgAwIBAgIJAN1EtEOQiWIsMA0GCSqGSIb3DQEBCwUAMH0xCzAJBgNV
BAYTAk5MMRAwDgYDVQQIDAdVdHJlY2h0MRAwDgYDVQQHDAdVdHJlY2h0MQ0wCwYD
VQQKDARURVNUMQ0wCwYDVQQLDARURVNUMQ0wCwYDVQQDDARURVNUMR0wGwYJKoZI
hvcNAQkBFg5URVNUQFRFU1QuVEVTVDAeFw0xNDExMDMwOTU1MTdaFw0xNDEyMDMw
OTU1MTdaMH0xCzAJBgNVBAYTAk5MMRAwDgYDVQQIDAdVdHJlY2h0MRAwDgYDVQQH
DAdVdHJlY2h0MQ0wCwYDVQQKDARURVNUMQ0wCwYDVQQLDARURVNUMQ0wCwYDVQQD
DARURVNUMR0wGwYJKoZIhvcNAQkBFg5URVNUQFRFU1QuVEVTVDCCASIwDQYJKoZI
hvcNAQEBBQADggEPADCCAQoCggEBALtd/946EREbvIYN+cc6zFtcCv1TEHuhYsL5
lCIkkDdkDzlnkxvCkoj4bf5p5uE7SadPaV6DAKRhqyfNxtZVs9v2DWImxD5lo9/0
U2PSd3Wc9uxJkhpOIDgZaHV4jiGChjgVWnyr65hNc6KZuP7bSlKangXcd/VTRx9L
cUjjAu8BbyAV7h4DtfcFAN5h0wXavFXynerPTLaf663xk0WPMTASuFOePonYo4+f
R6Fx9Jehucw+U6PD+VWvFoUVYqpR4cbp3ZHhxvVmf1FdjwVjtxexRwIp81114gDd
eSDG9zZYLPsGIERrvweTcAKNAwtz/43jkbW2tUn2piKYmyHcAlcCAwEAAaNQME4w
HQYDVR0OBBYEFJy/P2Rt3MzA9MXtFMkO031PmRSdMB8GA1UdIwQYMBaAFJy/P2Rt
3MzA9MXtFMkO031PmRSdMAwGA1UdEwQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEB
AG7tnfMrBb5CuXAe6YRbEolpUdyH6yROIePIEME1aV4tpuVaogFQelRTZ/SQxyGs
lbjlHVaSV9Oztxh63eidnQrhecrRNyqachy9l4Y3yeaB6c4076gaN9n1+EbsSOmF
QrKicLUvCls7t0T95xz6IJ2J4Y+RqYo5AMx4DiCVQgPVKlgTmx61od+lZme+ZuYr
z1sPUcnvLzEEhdyJFXZV3SDFklpNueEuhrgoNhbbGmPa+F3/KhNYwCBtdz7bZb9n
80dGuiAxTneLTisjhAH6fG9Xw0GQrW367fj6jiiexHNODCcNMjNZ6w/OAbOBVi6m
AyE2FKXieqVPtMkC4OWOJnQ=
-----END CERTIFICATE-----
```

server.pem
```
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAu13/3joRERu8hg35xzrMW1wK/VMQe6FiwvmUIiSQN2QPOWeT
G8KSiPht/mnm4TtJp09pXoMApGGrJ83G1lWz2/YNYibEPmWj3/RTY9J3dZz27EmS
Gk4gOBlodXiOIYKGOBVafKvrmE1zopm4/ttKUpqeBdx39VNHH0txSOMC7wFvIBXu
HgO19wUA3mHTBdq8VfKd6s9Mtp/rrfGTRY8xMBK4U54+idijj59HoXH0l6G5zD5T
o8P5Va8WhRViqlHhxundkeHG9WZ/UV2PBWO3F7FHAinzXXXiAN15IMb3Nlgs+wYg
RGu/B5NwAo0DC3P/jeORtba1SfamIpibIdwCVwIDAQABAoIBADOSmRYbF42E++xO
Nn1fMtbGzAOUdIoDDwMp3VtUgxmsAgDEAJr4gIsRDn2jurguMITL9+3a0zdr5seK
/XsLlfkqjd6BWyztnyDKyJVGXjlSXikFyyBQds/aNoV3DHAu1DDlt8VvMOb4Eqcj
9ua3h4qbInnsiFxPctkrU+BDFBCi8/35fL0F8P/a/1CvDY6wbbPf4ReWVgDkox+1
j7qgwXmRlMg4pyrwb5gRF48M/7v0TX/+mogQqKxnXQw4thdMfARyD0Vx6sz7oj2n
8SZ9cqnTpsRSOEA1bx5vWPZiZWjMZB0VC8RcaWBYpS5PuGFQwUvwNpcHa5oX3ezj
JeQ2RzkCgYEA9riJW0VTfON3IXlP/WsVskLEAGKH/HHQtTRYGqpkLDI6uzOybWww
0tchUyZE9g9IMzfy9wBGSenXy9fILfrjB4UAHtDeoct3DVG3c5fkJlNqt8+MQhDZ
vNek3kPES7EWAyfl9vFy+bzKKZcvGeccYefmCD0ivKyXd2S5VRWvuLsCgYEAwmn/
WBnGZ2Z1+MYQK6pS4Kjvu8DpIWtjDzAmHdlVgd83u9F+LqS4rnDtygSrReb2t9yv
AcZ8A6zWYIYF46M8AAH+WuyI7LnJw4ZH4OVdfVWtT7g6mX57toaxmIaJZIDu0W75
YNXbcMyuNFcPbAsqJt6/wQb1/zTb8Ied+1apYRUCgYEAvuBwLDPLbrDQxw4C663A
YGS1HRMd4Bnx/W8cxqySyXqm45QQdAWjFEuqFZli+vdBxZaAm8YTmzWWZbdwwNn8
cSHdwPmZdJVkauKQypZ1xYz94G1rNuWwfyBbBjZplKHRxOlGSjHs4PfFdD3qC+E4
nSp7Vl5uFIh2usErfX9ErucCgYB3OopefXAv+aZf6xf/r3UkUnazrptK45Dcv6qg
o6jM/RgxF0lLUbnxQVCTlEl1lS+5kp3BePiVSGowyADUmkcxugdDu8w9YbNbNf7e
7ctoEiM3wMQvXmKAjhpccCXSfT/5MRW/TWhGxUAQ2VOb7zzqmbD/sEUtPj2kRYed
nIhEAQKBgQDdzym2bRWU3/W+A3rsbWJIPzLE3NxknP7Yxr5X0GLmrJZTzlKydHX2
fX1vpemO+WB2UlZdwEezHsiIYFDXefujxVd4R0tl7iSgdXMcOgfFLvzQhjPjsaqX
j6aOJv/Xj/2NzAiY97z61XqndWHPsO0E4zBM/YVqXOLdngnnNEva5w==
-----END RSA PRIVATE KEY-----
```

### Metadata

Copy the files in `{ssp-root}/metadata-templates` to the `{ssp-root}/metadata` folder. Then add the following to `{ssp-root}/metadata/saml20-sp-remote.php`, this registers the Gateway as SP for SimpleSAMLphp

Remove the examples in this file and put: 


```
$metadata['https://gw-dev.stepup.coin.surf.net/app_dev.php/authentication/metadata'] = array(
    'entityid'                 => 'https://gw-dev.stepup.coin.surf.net/app_dev.php/authentication/metadata',
    'contacts'                 => array(),
    'metadata-set'             => 'saml20-sp-remote',
    'AssertionConsumerService' => array(
        0 => array(
            'Binding'  => 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST',
            'Location' => 'https://gw-dev.stepup.coin.surf.net/app_dev.php/authentication/consume-assertion',
            'index'    => 0,
        ),
    ),
    'SingleLogoutService'      => array(),
    'saml20.sign.response' => false,
    'saml20.sign.assertion' => true,
    'ForceAuthn' => true
);

$metadata['https://gw-dev.stepup.coin.surf.net/app_dev.php/gssp/tiqr/metadata'] = array(
    'entityid'                 => 'https://gw-dev.stepup.coin.surf.net/app_dev.php/gssp/tiqr/metadata',
    'contacts'                 => array(),
    'metadata-set'             => 'saml20-sp-remote',
    'AssertionConsumerService' => array(
        0 => array(
            'Binding'  => 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST',
            'Location' => 'https://gw-dev.stepup.coin.surf.net/app_dev.php/gssp/tiqr/consume-assertion',
            'index'    => 0,
        ),
    ),
    'SingleLogoutService'      => array(),
    'saml20.sign.response'     => false,
    'saml20.sign.assertion'    => true,
    'ForceAuthn' => true
);
```

### Enabling the auth module

In order to be able to use SimpleSAMLphp as easily configurable IdP, some form of authentication must be enabled. In
order to do this, we must add an empty `enable` file to the `modules/exampleauth` directory of SimpleSAMLphp, e.g.
in the SimpleSAMLphp directory, run `touch modules/exampleauth/enable`.

### User Accounts

Accounts can be added to the `$config` array in your git-ignored `simplesamlphp/config/authsources.php` file.
They should be added under the `example-userpass` key - which should be uncommented.
For development purposes, it could be useful to add SRAA, RAA and RA accounts as well as users for each
second factor. The following accounts can be used out of the box when copied and refer to the same SRAA account
as for the following sections with respect to the middelware

```php
    ...
        'sraa:sraa' => array(
            'commonName'              => 'SRAA',                     // displayName
            'mail'                    => 'sraa@sraa.example',        // email (also used for EPTI)
            'schacHomeOrganization'   => 'dev.organisation.example', // schacHomeOrganisation
        ),
        'raa:raa' => array(
            'commonName'              => 'RAA',                      // displayName
            'mail'                    => 'raa@raa.example',          // email (also used for EPTI)
            'schacHomeOrganization'   => 'dev.organisation.example', // schacHomeOrganisation
        ),
        'ra:ra' => array(
            'commonName'              => 'RA',                       // displayName
            'mail'                    => 'ra@ra.example',            // email (also used for EPTI)
            'schacHomeOrganization'   => 'dev.organisation.example', // schacHomeOrganisation
        ),
        'sms:sms' => array(
            'commonName'              => 'SMS',                      // displayName
            'mail'                    => 'sms@sms.example',          // email (also used for EPTI)
            'schacHomeOrganization'   => 'dev.organisation.example', // schacHomeOrganisation
        ),
        'yubi:yubi' => array(
            'commonName'              => 'Yubi',                     // displayName
            'mail'                    => 'yubi@yubi.example',        // email (also used for EPTI)
            'schacHomeOrganization'   => 'dev.organisation.example', // schacHomeOrganisation
        ),
        'u2f:u2f' => array(
            'commonName'              => 'U2F',                      // displayName
            'mail'                    => 'u2f@u2f.example',          // email (also used for EPTI)
            'schacHomeOrganization'   => 'dev.organisation.example', // schacHomeOrganisation
        ),
    ...
```

## Configuring the Middleware

First of all, in the Stepup-Middleware directory, please ensure all migrations ran by running `app/console mid:mig:mig`.

All these calls can be made using the Postman collections as provided in the Stepup-Middelware/docs/postman directory.

To whitelist the organisation of these accounts, use the [Middleware Manager API][middleware-manager]:

```
    POST /app_dev.php/management/whitelist/add HTTP/1.1

     {
       "institutions": [
         "dev.organisation.example"
       ]
     }
```

To allow account `sraa` to be added as an SRAA, use the [Middleware Manager API][middleware-manager] 
(request body has been truncated) to configure its NameID as such: 

```
      POST /app_dev.php/management/configuration HTTP/1.1

      {
          "sraa": [
            "9971dbcf01267b11f6107d9cafb43e5b4009a955"
          ],
          ...
      }
```

To add `sraa` by its NameID as an SRAA, run the following for Stepup-Middleware, replacing `<YOUR_YUBIKEY_PUBLIC_ID>` 
with the public id relating to your Yubikey (it is usually printed on it):

```
    app/console middleware:bootstrap:identity-with-yubikey 9971dbcf01267b11f6107d9cafb43e5b4009a955 'dev.organisation.example' 'SRAA' sraa@sraa.example nl_NL <YOUR_YUBIKEY_PUBLIC_ID>
```

Keep in mind that the SRAA should be configured with the same NameID as configured through the Middleware Management API.

To add `raa` and `ra` as RAA and RA respectively, they first have to go through the vetting process.
The first RA should be vetted by the `sraa` in RA and can be accredited as RAA.

Make sure RAAs and RAs are registered conform the LoA required for RA (loa3 by default). 

The LoA required for RA is configured in Stepup-RA's `parameters.yml` and through the [Middleware Manager API][middleware-manager]: 

```
    POST /app_dev.php/management/configuration HTTP/1.1

    "gateway": {
        "identity_providers": [],
        "service_providers": [
            ...
            {
               "entity_id": "https://ra-dev.stepup.coin.surf.net/app_dev.php/authentication/metadata",
               "public_key": "MIIEJTCCAw2gAwIBAgIJANug+o++1X5IMA0GCSqGSIb3DQEBCwUAMIGoMQswCQYDVQQGEwJOTDEQMA4GA1UECAwHVXRyZWNodDEQMA4GA1UEBwwHVXRyZWNodDEVMBMGA1UECgwMU1VSRm5ldCBCLlYuMRMwEQYDVQQLDApTVVJGY29uZXh0MRwwGgYDVQQDDBNTVVJGbmV0IERldmVsb3BtZW50MSswKQYJKoZIhvcNAQkBFhxzdXJmY29uZXh0LWJlaGVlckBzdXJmbmV0Lm5sMB4XDTE0MTAyMDEyMzkxMVoXDTE0MTExOTEyMzkxMVowgagxCzAJBgNVBAYTAk5MMRAwDgYDVQQIDAdVdHJlY2h0MRAwDgYDVQQHDAdVdHJlY2h0MRUwEwYDVQQKDAxTVVJGbmV0IEIuVi4xEzARBgNVBAsMClNVUkZjb25leHQxHDAaBgNVBAMME1NVUkZuZXQgRGV2ZWxvcG1lbnQxKzApBgkqhkiG9w0BCQEWHHN1cmZjb25leHQtYmVoZWVyQHN1cmZuZXQubmwwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDXuSSBeNJY3d4p060oNRSuAER5nLWT6AIVbv3XrXhcgSwc9m2b8u3ksp14pi8FbaNHAYW3MjlKgnLlopYIylzKD/6Ut/clEx67aO9Hpqsc0HmIP0It6q2bf5yUZ71E4CN2HtQceO5DsEYpe5M7D5i64kS2A7e2NYWVdA5Z01DqUpQGRBc+uMzOwyif6StBiMiLrZH3n2r5q5aVaXU4Vy5EE4VShv3Mp91sgXJj/v155fv0wShgl681v8yf2u2ZMb7NKnQRA4zM2Ng2EUAyy6PQ+Jbn+rALSm1YgiJdVuSlTLhvgwbiHGO2XgBi7bTHhlqSrJFK3Gs4zwIsop/XqQRBAgMBAAGjUDBOMB0GA1UdDgQWBBQCJmcoa/F7aM3jIFN7Bd4uzWRgzjAfBgNVHSMEGDAWgBQCJmcoa/F7aM3jIFN7Bd4uzWRgzjAMBgNVHRMEBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBd80GpWKjp1J+Dgp0blVAox1s/WPWQlex9xrx1GEYbc5elp3svS+S82s7dFm2llHrrNOBt1HZVC+TdW4f+MR1xq8O5lOYjDRsosxZc/u9jVsYWYc3M9bQAx8VyJ8VGpcAK+fLqRNabYlqTnj/t9bzX8fS90sp8JsALV4g84Aj0G8RpYJokw+pJUmOpuxsZN5U84MmLPnVfmrnuCVh/HkiLNV2c8Pk8LSomg6q1M1dQUTsz/HVxcOhHLj/owwh3IzXf/KXV/E8vSYW8o4WWCAnruYOWdJMI4Z8NG1Mfv7zvb7U3FL1C/KLV04DqzALXGj+LVmxtDvuxqC042apoIDQV",
               "acs": [
                    "https://ra-dev.stepup.coin.surf.net/app_dev.php/authentication/consume-assertion"
                ],
                "loa": {
                    "__default__": "https://gw-dev.stepup.coin.surf.net/authentication/loa3"
                },
                "assertion_encryption_enabled": false,
                "blacklisted_encryption_algorithms": []
            }
        ]
    }
```
[postman-chrome]: https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop
[saml-chrome-panel]: https://chrome.google.com/webstore/detail/saml-chrome-panel/paijfdbeoenhembfhkhllainmocckace
[firefox-saml-tracer]: https://addons.mozilla.org/en-US/firefox/addon/saml-tracer/
[middleware-manager]: https://github.com/OpenConext/Stepup-Middleware/tree/e1c7017f4211728157ecd49394e870858c9789c8#management-api
