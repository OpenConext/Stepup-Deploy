---
- name: Install Nginx
  yum: name=nginx state=present

- name: Install php5-cli
  sudo: yes
  yum: pkg=php-cli state=present

- name: Ensure timezone is set in cli php.ini
  lineinfile: dest=/etc/php.ini regexp='date.timezone =' line='date.timezone = {{ timezone }}'

- name: Install PHP Packages
  sudo: yes
  yum: pkg={{ item }} state=present
  with_items: php_packages

- name: Configure XDebug
  copy: src=xdebug.ini dest=/etc/php.d/xdebug.ini
  notify: restart php-fpm

- name: Install php-fpm
  sudo: yes
  yum: pkg=php-fpm state=present

- name: Prepare for copying certificates
  shell: mkdir /etc/nginx/conf.d/ssl && chown nginx:nginx /etc/nginx/conf.d/ssl creates=/etc/nginx/conf.d/ssl

- name: Copy CA certificate
  copy: src=../../../../../ssl/ca.crt dest=/etc/nginx/conf.d/ssl/ca.crt owner=nginx group=nginx mode=600

- name: Copy SSL certificate
  copy: src=../../../../../ssl/server.crt dest=/etc/nginx/conf.d/ssl/server.crt owner=nginx group=nginx mode=600

- name: Copy SSL key
  copy: src=../../../../../ssl/server.key dest=/etc/nginx/conf.d/ssl/server.key owner=nginx group=nginx mode=600

- name: Create SSL certificate chain
  shell: 'cat /etc/nginx/conf.d/ssl/server.crt /etc/nginx/conf.d/ssl/ca.crt > /etc/nginx/conf.d/ssl/server.chain.crt && chown nginx:nginx /etc/nginx/conf.d/ssl/server.chain.crt'

- name: Copy SSL configuration
  copy: src=ssl.conf dest=/etc/nginx/conf.d/ssl.conf owner=nginx group=nginx mode=600

- name: Create PHP session directory
  shell: mkdir /var/lib/php/session creates=/var/lib/php/session

- include: vhost.yml vhost_name=mw-dev tpl=default vhost_local_port=9000 user=middleware port=80
- include: vhost.yml vhost_name=gw-dev tpl=default vhost_local_port=9001 user=gateway port=443
- include: vhost.yml vhost_name=ss-dev tpl=default vhost_local_port=9002 user=selfservice port=443
- include: vhost.yml vhost_name=ra-dev tpl=default vhost_local_port=9003 user=ra port=443
- include: vhost.yml vhost_name=idp-dev tpl=simplesaml vhost_local_port=9004 user=simplesaml port=443
  notify:
   - restart nginx
   - restart php-fpm

- name: Add nginx to user groups
  user: name=nginx groups=nginx,middleware,gateway,selfservice,ra createhome=no state=present

- name: Remove default PHP-FPM vhost 'www'
  file: path=/etc/php-fpm.d/www.conf state=absent
  notify: restart php-fpm

- name: Add firewall rule for HTTP
  sudo: yes
  firewalld: service=http permanent=true state=enabled
  notify: Reload firewall

- name: Add firewall rule for HTTPS
  sudo: yes
  firewalld: service=https permanent=true state=enabled
  notify: Reload firewall

- name: Add eth1 interface to firewall
  command: firewall-cmd --zone=public --add-interface=eth1

- name: Install NodeJS
  yum: name=nodejs state=present

- name: Install NPM
  shell: wget -O- https://www.npmjs.org/install.sh | sudo sh creates=/usr/bin/npm

- name: Install LESS compiler
  npm: name=less version=1.x global=yes state=present

- include: mailcatcher.yml
