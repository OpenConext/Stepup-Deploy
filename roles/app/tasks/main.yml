- name: Install nginx & php-fpm
  yum: name={{item}} state=present
  with_items:
  - nginx
  - php-fpm


- name: Start nginx & php-fpm services on boot
  service: name={{item}} enabled=true
  with_items:
  - nginx
  - php-fpm


# Remove default distro conf files
- name: Remove conf.d/welcome.conf
  file: path={{item}} state=absent
  with_items:
  - /etc/php-fpm.d/www.conf
  - /etc/nginx/conf.d/default.conf
  - /etc/nginx/conf.d/ssl.conf
  - /etc/nginx/conf.d/virtual.conf
  notify:
  #- restart httpd
  - restart nginx
  - restart php-fpm


# Create vhosts
- include: vhost.yml vhost_name=gateway
- include: vhost.yml vhost_name=selfservice
- include: vhost.yml vhost_name=ra

# nginx will start with invalid vhost config, so test config explicitly first
- name: Test nginx config
  command: /sbin/service nginx configtest


- name: Start nginx & php-fpm services
  service: name={{item}} state=running
  with_items:
  - nginx
  - php-fpm