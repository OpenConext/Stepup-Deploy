---

# Deploy a Symphony app

- debug: var=deploy_release_name
- debug: var=deploy_git_repo
- debug: var=deploy_git_branch
- debug: var=deploy_web_dir
- debug: var=deploy_component


- name: Create deploy directory
  file: state=directory path=/opt/stepup/{{ deploy_component }}

- name: Checkout component from git
  git: repo={{ deploy_git_repo }} dest=/opt/stepup/{{ deploy_component }}/{{ deploy_release_name }} version={{ deploy_git_branch }}

- name: Create bin directory
  file: state=directory path=/opt/stepup/{{ deploy_component }}/{{ deploy_release_name }}/bin

- name: Install composer in repo when needed
  command: bash -c "curl -sS https://getcomposer.org/installer | php"
  args:
    chdir: /opt/stepup/{{ deploy_component }}/{{ deploy_release_name }}/bin
    creates: /opt/stepup/{{ deploy_component }}/{{ deploy_release_name }}/bin/composer.phar

- name: Run composer install
  command: /opt/stepup/{{ deploy_component }}/{{ deploy_release_name }}/bin/composer.phar install
  args:
     chdir: /opt/stepup/{{ deploy_component }}/{{ deploy_release_name }}

- name: Enable app
  file: src=/opt/stepup/{{ deploy_component }}/{{ deploy_release_name }} dest=/opt/www/{{ deploy_component }}.{{ app_domain }} state=link