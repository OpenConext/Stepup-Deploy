filter {

  # Parse stepup-authentication channel messages generated by the gateway.
  # See: https://github.com/SURFnet/Stepup-Gateway/blob/develop/src/Surfnet/StepupGateway/GatewayBundle/Monolog/Logger/AuthenticationLogger.php
  # The gateway logs these using the flat format of the gateway.monolog.gelf_to_string_formatter

  if [prog] == "stepup-authentication" {

    # Parse JSON into stepup_json
    json {
      source => "message"
      target => "json"
    }

    if "_jsonparsefailure" not in [tags] {

      # stepup_request_id: A random ID generated by stepup applications for correlating API calls belonging
      #                    to the same client HTTP request, unrelated to SAML RequestID
      #                    Used in X-Stepup-Request-Id HTTP header
      #                    See: https://github.com/SURFnet/Stepup-bundle/blob/develop/src/Request/RandomRequestIdGenerator.php
      #                         https://github.com/SURFnet/Stepup-bundle/blob/develop/src/EventListener/RequestIdRequestResponseListener.php
      #
      # stepup_sari: The SAML Request ID from the SAML AuthenticationRequest from the SP.
      #

      mutate {
        replace => {
          "message" => "%{[json][short_message]}"
          "severity" => "informational"
          "generated_at" => "%{[json][_ctxt_datetime]}"
          "stepup_request_id" => "%{[json][_request_id]}"
          "stepup_sari" => "%{[json][_ctxt_sari]}"
          "idp" => "%{[json][_ctxt_authenticating_idp]}"
          "sp" => "%{[json][_ctxt_requesting_sp]}"
          "nameid" => "%{[json][_ctxt_identity_id]}"
          "result" => "%{[json][_ctxt_authentication_result]}"
          "second_factor_id" => "%{[json][_ctxt_second_factor_id]}"
          "second_factor_type" => "%{[json][_ctxt_second_factor_type]}"
          "institution" => "%{[json][_ctxt_institution]}"
        }
      }

      mutate {
        remove_field => "json"
      }

    }

  }

}