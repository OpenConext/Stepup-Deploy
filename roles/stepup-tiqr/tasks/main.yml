# Infra stuff for tiqr IDP

- name: Get active component
  shell: readlink /opt/www/{{ tiqr_vhost_name }}
  ignore_errors: true
  register: active_component

- debug:
    msg: "Currently installed component: {{ active_component.stdout }}; Component to be installed: {{ component_dir_name }}; Asset version: {{ stable_nonce }}"

- name: Check whether component is installed
  fail: msg="Component already active"
  when: ( 0 ) and ( component_dir_name != active_component.stdout)

- name: Create stepup-tiqr directory
  file: path={{ component_dir_name }} state=directory mode=a+rx

- name: Untar component
  unarchive: copy=yes src={{ component_tarball_name }} dest={{ component_dir_name }}
  when: ( {{ component_unarchive | default(1) }} == 1)

# config stuff

- name: Put local config
  template: src=local_config.php.j2 dest={{ component_dir_name }}/local_config.php

- name: Put local options
  template: src=local_options.php.j2 dest={{ component_dir_name }}/local_options.php

- name: Create log directory
  file: path={{ component_dir_name }}/logs state=directory mode=a+rx

- name: Grant app write access to log dirs (similar to symfony2 apps)
  file: path={{item}} owner=tiqr recurse=yes
  with_items:
  - "{{ component_dir_name }}/logs"

# Finish

- name: Set stepup directory rights
  file: path={{ component_dir_name }} state=directory mode=a+rx

- name: Activate componen
  file: src={{ component_dir_name }} dest=/opt/www/{{ tiqr_vhost_name }} state=link

- name: Put tiqr configuration script in /root/
  template: src={{ item }}.j2 dest=/root/{{ item }} group=root owner=root mode="500"
  with_items:
  - "01-tiqr-db_init.sh"

# TODO: Put cert in config. Hint: {{ gateway_tiqr_sp_publickey | depem }}
- name: Write tiqr sp certificate
  copy: content="{{ gateway_tiqr_sp_publickey }}" dest={{ component_dir_name }}/gateway.crt

# TODO: Explicitly config filenames
- name: Write tiqr idp certificate
  copy: content="{{ tiqr_idp_publickey }}" dest={{ component_dir_name }}/cert.pem

# TODO: Explicitly config filenames
- name: Write tiqr idp certificate
  copy: content="{{ tiqr_idp_privatekey | vault(vault_keydir) }}" dest={{ component_dir_name }}/key.pem

# TODO: change in Stepup-tiqr

- name: create symlink to match generic nginx config
  file: src=/opt/www/{{ tiqr_vhost_name }}/www dest=/opt/www/{{ tiqr_vhost_name }}/web state=link

# TODO: Log to syslog
- name: Create log files
  file: name={{ component_dir_name }}/authn.log owner=tiqr mode=u+rw state=touch

- name: Create log file
  file: name={{ component_dir_name }}/saml.log owner=tiqr mode=u+rw state=touch
